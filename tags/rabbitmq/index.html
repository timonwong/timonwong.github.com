<!DOCTYPE html>
<html>
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8">
  
  <title>Tag: RabbitMQ | Timon Wong&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description">
<meta property="og:type" content="website">
<meta property="og:title" content="Timon Wong's Blog">
<meta property="og:url" content="http://theo.im/tags/rabbitmq/index.html">
<meta property="og:site_name" content="Timon Wong's Blog">
<meta property="og:description">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Timon Wong's Blog">
<meta name="twitter:description">
<meta name="twitter:creator" content="@timonwong">
  
    <link rel="alternate" href="/atom.xml" title="Timon Wong&#39;s Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.lug.ustc.edu.cn/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css"><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</head>

<body>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Timon Wong&#39;s Blog</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">(╯°□°）╯ ┻━┻</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/blog/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        
<form class="search-form">
  <input type="search" id="st-search-input" class="search-form-input" placeholder="Search">
  <input type="submit" value="&#xF002;" class="search-form-submit">
</form>


      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-rabbitmq-note-3-pika-send-large-message" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2014/05/15/rabbitmq-note-3-pika-send-large-message/" class="article-date">
  <time datetime="2014-05-15T02:27:25.000Z" itemprop="datePublished">May 15 2014</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/blog/categories/it/">IT</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2014/05/15/rabbitmq-note-3-pika-send-large-message/">RabbitMQ笔记（三）: Pika客户端（Python）发送大尺寸消息的问题</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h2><p>这个问题存在很久了，现象就是使用 <a href="https://pypi.python.org/pypi/pika/" target="_blank" rel="external">Pika</a> 库的客户端在发送大尺寸消息后，RabbitMQ
没有收到，Consumer 那里会认为消息已丢失。</p>
<p><strong>NOTE:</strong> 即使在本文写时的最新版(v0.9.13)依然存在这个问题。</p>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>因为网络状态很好，所以没有考虑网络的错误，直接考虑<a href="https://pypi.python.org/pypi/pika/" target="_blank" rel="external">Pika</a>库的问题。</p>
<p>那么第一步就是把 <a href="https://pypi.python.org/pypi/pika/" target="_blank" rel="external">Pika</a> 的代码拿来读一遍，主要看它是怎么发送消息的，经过一番探索，找到了
<code>pika/adapters/base_connection.py</code> 这个文件，来看看里面的内容：</p>
<figure class="highlight python"><figcaption><span>pika/adapters/base_connection.py</span><a href="https://github.com/pika/pika/blob/0.9.13/pika/adapters/base_connection.py#L329" target="_blank" rel="external">link</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_handle_write</span><span class="params">(self)</span>:</span></span><br><span class="line">    <span class="string">"""Handle any outbound buffer writes that need to take place."""</span></span><br><span class="line">    total_written = <span class="number">0</span></span><br><span class="line">    <span class="keyword">if</span> self.outbound_buffer:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            bytes_written = self.socket.send(self.outbound_buffer.popleft())</span><br><span class="line">        <span class="keyword">except</span> socket.timeout:</span><br><span class="line">            <span class="keyword">raise</span></span><br><span class="line">        <span class="keyword">except</span> socket.error, error:</span><br><span class="line">            <span class="keyword">return</span> self._handle_error(error)</span><br><span class="line">        total_written += bytes_written</span><br><span class="line">    <span class="keyword">return</span> total_written</span><br></pre></td></tr></table></figure>
<p>看出问题了吗？</p>
<p>来看看<code>socket.send</code>的文档吧：</p>
<blockquote><p>Send data to the socket. The socket must be connected to a remote socket. The optional flags argument has the same meaning as for recv() above. Returns the number of bytes sent. Applications are responsible for checking that all data has been sent; if only some of the data was transmitted, the application needs to attempt delivery of the remaining data. For further information on this concept, consult the Socket Programming HOWTO.</p>
<footer><strong>Python Docs</strong><cite><a href="https://docs.python.org/2/library/socket.html#socket.socket.send" target="_blank" rel="external">socket.send</a></cite></footer></blockquote>
<p>问题就是，没有检查 <code>socket.send</code> 的返回值，由于 <code>socket.send</code> 返回实际发送的直接个数，可能会小于期望（在这里是
<code>self.outbound_buffer.popleft()</code>）。</p>
<p>由于 <code>socket.send</code> 可能没有将数据发送完成就返回了，造成了消息丢失的情况。</p>
<p>本来想自己修的，看了一眼 <a href="https://pypi.python.org/pypi/pika/" target="_blank" rel="external">Pika</a> 的 <code>master</code> 分支，已经修正了（一次保证将一个帧(Frame)发送完成）：</p>
<figure class="highlight python"><figcaption><span>pika/adapters/base_connection.py</span><a href="https://github.com/pika/pika/blob/master/pika/adapters/base_connection.py#L354" target="_blank" rel="external">link</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_handle_write</span><span class="params">(self)</span>:</span></span><br><span class="line">    <span class="string">"""Handle any outbound buffer writes that need to take place."""</span></span><br><span class="line">    bytes_written = <span class="number">0</span></span><br><span class="line">    <span class="keyword">if</span> self.outbound_buffer:</span><br><span class="line">        frame = self.outbound_buffer.popleft()</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            self.socket.sendall(frame)</span><br><span class="line">            bytes_written = len(frame)</span><br><span class="line">        <span class="keyword">except</span> socket.timeout:</span><br><span class="line">            <span class="keyword">raise</span></span><br><span class="line">        <span class="keyword">except</span> socket.error <span class="keyword">as</span> error:</span><br><span class="line">            <span class="keyword">return</span> self._handle_error(error)</span><br><span class="line">    <span class="keyword">return</span> bytes_written</span><br></pre></td></tr></table></figure>
<p>呵呵……</p>
<h2 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h2><ol>
<li>自行打补丁；</li>
<li>使用 <code>git</code> 上的 Pika: <code>pip install git+https://github.com/pika/pika.git</code>；</li>
<li>不用 <a href="https://pypi.python.org/pypi/pika/" target="_blank" rel="external">Pika</a>, 换其它的，比如 <a href="http://kombu.readthedocs.org/" target="_blank" rel="external">Kombu</a>。</li>
</ol>
<p>我现在不用 <a href="https://pypi.python.org/pypi/pika/" target="_blank" rel="external">Pika</a> 了，用 <a href="http://kombu.readthedocs.org/" target="_blank" rel="external">Kombu</a>。</p>
<p><strong>PS:</strong> <a href="https://pypi.python.org/pypi/pika/" target="_blank" rel="external">Pika</a> 的发布也太不积极了，都怎么久了还不发新版本。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://theo.im/blog/2014/05/15/rabbitmq-note-3-pika-send-large-message/" data-id="ciopu3kxf000g1nsm0oybxcpo" class="article-share-link">Share</a>
      
        <a href="http://theo.im/blog/2014/05/15/rabbitmq-note-3-pika-send-large-message/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/pika/">Pika</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/python/">Python</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/rabbitmq/">RabbitMQ</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-rabbitmq-note-2-about-simultaneous-connections" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2014/05/13/rabbitmq-note-2-about-simultaneous-connections/" class="article-date">
  <time datetime="2014-05-13T08:16:21.000Z" itemprop="datePublished">May 13 2014</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/blog/categories/it/">IT</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2014/05/13/rabbitmq-note-2-about-simultaneous-connections/">RabbitMQ笔记（二）: 并发连接数</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="概要"><a href="#概要" class="headerlink" title="概要"></a>概要</h2><p>对于服务器来说，并发连接数一直是一个需要考量的问题，因此在这里做一个简单的测试。</p>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>在测试前，需要准备一个客户端环境，本文的环境是:</p>
<ul>
<li>CentOS 6.3</li>
<li>Python 2.7.6<ul>
<li><a href="http://kombu.readthedocs.org/" target="_blank" rel="external">Kombu</a></li>
</ul>
</li>
</ul>
<p><strong>NOTE:</strong> 下文中的 IP 地址 <code>10.10.0.70</code> 为 RabbitMQ 服务器的 IP 地址</p>
<h3 id="测试-耗尽-rabbitmq-的-socket-descriptors"><a href="#测试-耗尽-rabbitmq-的-socket-descriptors" class="headerlink" title="测试: 耗尽 rabbitmq 的 socket descriptors"></a>测试: 耗尽 rabbitmq 的 socket descriptors</h3><p>首先, 编写一个脚本:</p>
<figure class="highlight python"><figcaption><span>exhaust_socket_descriptors.py</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> config</span><br><span class="line"></span><br><span class="line">logging.basicConfig(format=<span class="string">'%(asctime)s - %(name)s - %(levelname)s - %(message)s'</span>,</span><br><span class="line">                    level=logging.INFO)</span><br><span class="line">LOG = logging.getLogger(os.path.basename(__file__))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    connections = []</span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">        LOG.info(<span class="string">"Try to establish a new rabbit connection..."</span>)</span><br><span class="line">        connection = config.get_connection()</span><br><span class="line">        connection.connect()</span><br><span class="line">        connections.append(connection)</span><br><span class="line">        LOG.info(<span class="string">"[%d] connections"</span>, len(connections))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>
<p>在<strong>客户端</strong>执行<code>exhaust_socket_descriptors.py</code>, 会看到如下输出:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">...前略...</span><br><span class="line">2014-05-13 10:45:17,477 - exhaust_socket_descriptors.py - INFO - Try to establish a new rabbit connection...</span><br><span class="line">2014-05-13 10:45:17,489 - exhaust_socket_descriptors.py - INFO - [826] connections</span><br><span class="line">2014-05-13 10:45:17,489 - exhaust_socket_descriptors.py - INFO - Try to establish a new rabbit connection...</span><br><span class="line">2014-05-13 10:45:17,502 - exhaust_socket_descriptors.py - INFO - [827] connections</span><br><span class="line">2014-05-13 10:45:17,502 - exhaust_socket_descriptors.py - INFO - Try to establish a new rabbit connection...</span><br><span class="line">2014-05-13 10:45:17,516 - exhaust_socket_descriptors.py - INFO - [828] connections</span><br><span class="line">2014-05-13 10:45:17,516 - exhaust_socket_descriptors.py - INFO - Try to establish a new rabbit connection...</span><br><span class="line">2014-05-13 10:45:17,528 - exhaust_socket_descriptors.py - INFO - [829] connections</span><br><span class="line">2014-05-13 10:45:17,529 - exhaust_socket_descriptors.py - INFO - Try to establish a new rabbit connection...</span><br></pre></td></tr></table></figure>
<p>看到似乎是连接耗尽了，在<strong>服务器端</strong>上确认一下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost vagrant]# rabbitmqctl status | grep sockets_</span><br><span class="line">      &#123;sockets_limit,829&#125;,</span><br><span class="line">      &#123;sockets_used,829&#125;]&#125;,</span><br></pre></td></tr></table></figure>
<p><code>sockets_used</code> 与 <code>sockets_limit</code> 相同，可以确认 socket descriptors 耗尽了，因此客户端成功新连接，卡在
<code>Try to establish a new rabbit connection...</code> 处。但是问题在于，<strong>为什么不超时？</strong></p>
<p>在<strong>客户端</strong>中检查一下TCP连接个数:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# netstat -atn | grep 10.10.0.70:5672 | wc -l</span><br><span class="line">830</span><br></pre></td></tr></table></figure>
<p>可以得出，socket连接数是830，大于服务器端的<code>sockets_limit</code></p>
<p>继续，在<strong>客户端</strong>中，检查一下TCP连接状态：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# netstat -atn | grep 10.10.0.70:5672  | awk &apos;&#123;print $6&#125;&apos; | uniq</span><br><span class="line">ESTABLISHED</span><br></pre></td></tr></table></figure>
<p><strong>全部都是ESTABLISHED状态</strong>，因此服务器仅仅是阻塞了新连接，而不是拒绝新连接。这样，就产生了一个问题：</p>
<p>如果是使用 <a href="http://clusterlabs.org/" target="_blank" rel="external">HAProxy</a> 等工具搭建的集群，由于<strong>服务器依然会接受新连接</strong>，因此 <a href="http://clusterlabs.org/" target="_blank" rel="external">HAProxy</a> 不会认为节点已Down，<strong>最终会导致整个集群卡住</strong>；</p>
<h3 id="Bug"><a href="#Bug" class="headerlink" title="Bug"></a>Bug</h3><p>当 RabbitMQ 的 <code>sockets_used</code> 达到 <code>sockets_limits</code> 时候（连接数耗尽时），最终即使是 Consumer
也会全部阻塞，只有在 <code>sockets_used &lt; sockets_limit</code> 时（释放部分连接后），才会恢复。</p>
<p>参见以下连接获取更多信息: <a href="http://markmail.org/message/r4yhvqc7vgfljpao" target="_blank" rel="external">http://markmail.org/message/r4yhvqc7vgfljpao</a></p>
<h2 id="Workaround-增加File-Socket-Descriptors个数"><a href="#Workaround-增加File-Socket-Descriptors个数" class="headerlink" title="Workaround: 增加File/Socket Descriptors个数"></a>Workaround: 增加File/Socket Descriptors个数</h2><p>通过官方(包括EPEL)的 <code>deb</code>, <code>rpm</code> 包安装的启动脚本，都会在<code>rabbitmq-server</code>
启动前 <code>source</code> 一次 <code>/etc/default/rabbitmq-server</code> 文件，因此我们可以在该文件中增加最大允许的
File/Socket Descriptors 个数。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">'ulimit -n 102400'</span> &gt; /etc/default/rabbitmq-server</span><br></pre></td></tr></table></figure>
<p>最后，重启 RabbitMQ 服务器以生效该设置：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service rabbitmq-server restart</span><br></pre></td></tr></table></figure>
<h2 id="Updated"><a href="#Updated" class="headerlink" title="Updated"></a>Updated</h2><h3 id="May-17-2014"><a href="#May-17-2014" class="headerlink" title="May 17, 2014"></a>May 17, 2014</h3><ul>
<li>更新 Bug 说明 (RabbitMQ <code>bug26180</code>)</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://theo.im/blog/2014/05/13/rabbitmq-note-2-about-simultaneous-connections/" data-id="ciopu3kxa000c1nsmp9upufb7" class="article-share-link">Share</a>
      
        <a href="http://theo.im/blog/2014/05/13/rabbitmq-note-2-about-simultaneous-connections/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/rabbitmq/">RabbitMQ</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-rabbitmq-note-1-setup-experimental-rabbitmq-environment-using-vagrant" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2014/05/13/rabbitmq-note-1-setup-experimental-rabbitmq-environment-using-vagrant/" class="article-date">
  <time datetime="2014-05-13T06:46:31.000Z" itemprop="datePublished">May 13 2014</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/blog/categories/it/">IT</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2014/05/13/rabbitmq-note-1-setup-experimental-rabbitmq-environment-using-vagrant/">RabbitMQ笔记（一）: 通过Vagrant建立一个RabbitMQ服务器实验环境</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="安装Vagrant"><a href="#安装Vagrant" class="headerlink" title="安装Vagrant"></a>安装Vagrant</h2><p>在<a href="http://vagrantup.com" target="_blank" rel="external">官方网站</a>上，下载并安装Vagrant</p>
<p><strong>NOTE</strong>: Vagrant 1.6版本对<code>CentOS</code>的guest支持不好，不能正确设置网络连接，需要升级到最新版或打上下面这个补丁: <a href="https://github.com/cammoraton/vagrant/commit/1e4584cde51765972af41cd48fc0409756a8fd59" target="_blank" rel="external">Fix issue reported at mitchellh#3649</a></p>
<h2 id="下载并导入CentOS-6-3-Box"><a href="#下载并导入CentOS-6-3-Box" class="headerlink" title="下载并导入CentOS 6.3 Box"></a>下载并导入CentOS 6.3 Box</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vagrant box add --name centos63 <span class="string">'https://s3.amazonaws.com/itmat-public/centos-6.3-chef-10.14.2.box'</span></span><br></pre></td></tr></table></figure>
<h2 id="创建Vagrantfile"><a href="#创建Vagrantfile" class="headerlink" title="创建Vagrantfile"></a>创建Vagrantfile</h2><p><code>Vagrantfile</code> 文件内容如下:</p>
<figure class="highlight ruby"><figcaption><span>Vagrantfile</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- mode: ruby -*-</span></span><br><span class="line"><span class="comment"># vi: set ft=ruby :</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Vagrantfile API/syntax version. Don't touch unless you know what you're doing!</span></span><br><span class="line">VAGRANTFILE_API_VERSION = <span class="string">"2"</span></span><br><span class="line"></span><br><span class="line">Vagrant.configure(VAGRANTFILE_API_VERSION) <span class="keyword">do</span> <span class="params">|config|</span></span><br><span class="line">  config.vm.box = <span class="string">"centos63"</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 一个Host-Only的Network, IP地址可以自定义, 方便访问</span></span><br><span class="line">  config.vm.network <span class="symbol">:private_network</span>, <span class="symbol">ip:</span> <span class="string">"10.10.0.70"</span>, <span class="symbol">netmask:</span> <span class="string">"255.255.255.0"</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># config.vm.synced_folder "../", "/vagrant"</span></span><br><span class="line"></span><br><span class="line">  config.vm.provider <span class="symbol">:virtualbox</span> <span class="keyword">do</span> <span class="params">|vb|</span></span><br><span class="line">    <span class="comment"># 调节虚拟机CPU个数</span></span><br><span class="line">    vb.customize [<span class="string">"modifyvm"</span>, <span class="symbol">:id</span>, <span class="string">"--cpus"</span>, <span class="string">"2"</span>]</span><br><span class="line">    <span class="comment"># 调节虚拟机内存大小</span></span><br><span class="line">    vb.customize [<span class="string">"modifyvm"</span>, <span class="symbol">:id</span>, <span class="string">"--memory"</span>, <span class="string">"2048"</span>]</span><br><span class="line">    vb.customize [<span class="string">"modifyvm"</span>, <span class="symbol">:id</span>, <span class="string">"--natdnshostresolver1"</span>, <span class="string">"on"</span>]</span><br><span class="line">    vb.customize [<span class="string">"setextradata"</span>, <span class="symbol">:id</span>, <span class="string">"VBoxInternal2/SharedFoldersEnableSymlinksCreate/vagrant"</span>, <span class="string">"1"</span>]</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 自动安装脚本</span></span><br><span class="line">  config.vm.provision <span class="symbol">:shell</span>, <span class="symbol">path:</span> <span class="string">"provision.sh"</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>为了简化安装，提供一个用于自动安装的脚本<code>provision.sh</code>，文件内容如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/env bash</span><br><span class="line"></span></span><br><span class="line"><span class="comment"># Disable yum fastestmirror plugin</span></span><br><span class="line">sed -i.backup <span class="string">'s/^enabled=1/enabled=0/'</span> /etc/yum/pluginconf.d/fastestmirror.conf</span><br><span class="line"><span class="comment"># Change yum mirror (163)</span></span><br><span class="line">mv /etc/yum.repos.d/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo.backup</span><br><span class="line">wget -O /etc/yum.repos.d/CentOS-Base-163.repo http://mirrors.163.com/.help/CentOS6-Base-163.repo</span><br><span class="line">yum makecache</span><br><span class="line">yum update</span><br><span class="line"></span><br><span class="line"><span class="comment"># Install EPEL repository</span></span><br><span class="line">wget http://dl.fedoraproject.org/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm</span><br><span class="line">wget http://rpms.famillecollet.com/enterprise/remi-release-6.rpm</span><br><span class="line">rpm -Uvh remi-release-6*.rpm epel-release-6*.rpm</span><br><span class="line"></span><br><span class="line"><span class="comment"># Install and start rabbitmq-server</span></span><br><span class="line">yum -y install rabbitmq-server</span><br><span class="line"></span><br><span class="line"><span class="comment">## Automatically start</span></span><br><span class="line">chkconfig rabbitmq-server on</span><br><span class="line"></span><br><span class="line"><span class="comment">## Create a sample config and enable guest user remote access</span></span><br><span class="line"><span class="built_in">echo</span> &gt; /etc/rabbitmq/rabbitmq.config &lt;&lt;EOF</span><br><span class="line">[</span><br><span class="line">  &#123;rabbit, [</span><br><span class="line">    &#123;loopback_users, []&#125;</span><br><span class="line">  ]&#125;</span><br><span class="line">].</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment">## Enable magement plugin</span></span><br><span class="line">/usr/lib/rabbitmq/bin/rabbitmq-plugins <span class="built_in">enable</span> rabbitmq_management</span><br><span class="line"></span><br><span class="line"><span class="comment">## Start rabbitmq-server</span></span><br><span class="line">service rabbitmq-server start</span><br><span class="line"></span><br><span class="line"><span class="comment"># Disable iptables</span></span><br><span class="line">service iptables stop</span><br><span class="line">chkconfig iptables off</span><br></pre></td></tr></table></figure>
<h2 id="启动虚拟机"><a href="#启动虚拟机" class="headerlink" title="启动虚拟机"></a>启动虚拟机</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vagrant up</span><br></pre></td></tr></table></figure>
<h2 id="使用SSH连接到虚拟机"><a href="#使用SSH连接到虚拟机" class="headerlink" title="使用SSH连接到虚拟机"></a>使用SSH连接到虚拟机</h2><p>使用命令(如果支持的话):</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vagrant ssh</span><br></pre></td></tr></table></figure>
<p>或使用SSH工具，例如 <a href="http://www.netsarang.com/products/xsh_overview.html" target="_blank" rel="external">XShell</a>, <a href="http://www.chiark.greenend.org.uk/~sgtatham/putty/download.html" target="_blank" rel="external">PuTTY</a> 等工具，连接到 <code>10.10.0.70:22</code> (IP在之前 <code>Vagrantfile</code> 中定义)</p>
<h2 id="停止虚拟机"><a href="#停止虚拟机" class="headerlink" title="停止虚拟机"></a>停止虚拟机</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vagrant halt</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://theo.im/blog/2014/05/13/rabbitmq-note-1-setup-experimental-rabbitmq-environment-using-vagrant/" data-id="ciopu3kx8000a1nsm8vbykblk" class="article-share-link">Share</a>
      
        <a href="http://theo.im/blog/2014/05/13/rabbitmq-note-1-setup-experimental-rabbitmq-environment-using-vagrant/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/rabbitmq/">RabbitMQ</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/vagrant/">Vagrant</a></li></ul>

    </footer>
  </div>
  
</article>


  


</section>
        
          <aside id="sidebar">
  
    <div class="widget-wrap">
  <h3 class="widget-title">About</h3>
  <div class="widget">
    <img src="https://www.gravatar.com/avatar/27eba4a33a317761c17d96f1f009ae49?s=200" style="margin: auto; width: 100%"/>
    <h4 style="text-align: center"><strong>Timon Wong (timonwong)</strong></h4>
    <div class="about-links-holder">
    
      <a id="about-github-link" class="about-icon" href="https://github.com/timonwong" title="GitHub"></a>
    
    
      <a id="about-twitter-link" class="about-icon" href="https://twitter.com/timonwong" title="Twitter"></a>
    
    
      <a id="about-weibo-link" class="about-icon" href="http://weibo.com/uglifycode" title="Weibo"></a>
    
    
      <a id="about-email-link" class="about-icon" href="mailto:timon86.wang@gmail.com" title="Mail"></a>
    
    </div>
  </div>
</div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/blog/categories/it/">IT</a></li><li class="category-list-item"><a class="category-list-link" href="/blog/categories/miscellaneous/">Miscellaneous</a></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/beyond-compare-3/">Beyond Compare 3</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dns/">DNS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/">Docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/fpm/">FPM</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/git/">Git</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/github/">GitHub</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/go/">Go</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/golang/">Golang</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hardware/">Hardware</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hexo/">Hexo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/osx/">OSX</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/omnimarkuppreviewer/">OmniMarkupPreviewer</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pika/">Pika</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/">Python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/rpm/">RPM</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/rabbitmq/">RabbitMQ</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sublime-text-2/">Sublime Text 2</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sublime-text-3/">Sublime Text 3</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/unicode/">Unicode</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vagrant/">Vagrant</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/virtualbox/">VirtualBox</a></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/beyond-compare-3/" style="font-size: 10px;">Beyond Compare 3</a> <a href="/tags/dns/" style="font-size: 10px;">DNS</a> <a href="/tags/docker/" style="font-size: 10px;">Docker</a> <a href="/tags/fpm/" style="font-size: 10px;">FPM</a> <a href="/tags/git/" style="font-size: 10px;">Git</a> <a href="/tags/github/" style="font-size: 13.33px;">GitHub</a> <a href="/tags/go/" style="font-size: 13.33px;">Go</a> <a href="/tags/golang/" style="font-size: 10px;">Golang</a> <a href="/tags/hardware/" style="font-size: 10px;">Hardware</a> <a href="/tags/hexo/" style="font-size: 10px;">Hexo</a> <a href="/tags/osx/" style="font-size: 10px;">OSX</a> <a href="/tags/omnimarkuppreviewer/" style="font-size: 10px;">OmniMarkupPreviewer</a> <a href="/tags/pika/" style="font-size: 10px;">Pika</a> <a href="/tags/python/" style="font-size: 20px;">Python</a> <a href="/tags/rpm/" style="font-size: 10px;">RPM</a> <a href="/tags/rabbitmq/" style="font-size: 16.67px;">RabbitMQ</a> <a href="/tags/sublime-text-2/" style="font-size: 13.33px;">Sublime Text 2</a> <a href="/tags/sublime-text-3/" style="font-size: 10px;">Sublime Text 3</a> <a href="/tags/unicode/" style="font-size: 10px;">Unicode</a> <a href="/tags/vagrant/" style="font-size: 13.33px;">Vagrant</a> <a href="/tags/virtualbox/" style="font-size: 10px;">VirtualBox</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2016/05/">May 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2014/08/">August 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2014/07/">July 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2014/05/">May 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2012/12/">December 2012</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2012/11/">November 2012</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2012/10/">October 2012</a></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/blog/2016/05/22/evaluating-new-docker-for-mac-beta/">试用最新的 Docker for Mac Beta</a>
          </li>
        
          <li>
            <a href="/blog/2014/08/13/count-text-element-count-in-python/">在 Python 中统计文本字符个数</a>
          </li>
        
          <li>
            <a href="/blog/2014/08/08/Golang-memory-part-1/">Golang 内存模型（一）</a>
          </li>
        
          <li>
            <a href="/blog/2014/08/07/Remove-Intel-HD-Graphics-Hotkeys/">删除 Intel HD Graphics 显卡工具的全局快捷键</a>
          </li>
        
          <li>
            <a href="/blog/2014/08/05/VirtualBox-error-launching-vm-instance-in-supR3HardenedWinReSpawn/">VirtualBox与杀毒软件冲突导致虚拟机无法启动: 错误 &quot;supR3HardenedWinReSpawn&quot;</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2016 Timon Wong<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/blog/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    
<script type="text/javascript">
  var Swiftype = window.Swiftype || {};
  (function() {
    Swiftype.key = '_Fmagrbt4RavhXm_Hz4j';
    var script = document.createElement('script');
    script.type = 'text/javascript';
    script.async = true;
    script.src = "//s.swiftypecdn.com/embed.js";
    var entry = document.getElementsByTagName('script')[0];
    entry.parentNode.insertBefore(script, entry);
  }());
</script>



<script type="text/javascript">
  var disqus_shortname = 'theoim';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//go.disqus.com/count.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//ajax.lug.ustc.edu.cn/ajax/libs/jquery/2.1.1/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-35644871-2', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->





  </div><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</body>
</html>