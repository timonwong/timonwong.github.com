<!DOCTYPE html>
<html lang="en">
  <head>
    
<!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">


<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">

<meta name="theme-color" content="#f8f5ec">
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">















  <link rel="alternate" href="/atom.xml" title="Timon Wong">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=2.6.0">



<link rel="canonical" href="http://theo.im/blog/page/3/">


<link rel="stylesheet" type="text/css" href="/css/style.css?v=2.6.0">



  <link rel="stylesheet" type="text/css" href="https://cdn.staticfile.org/fancybox/2.1.5/jquery.fancybox.min.css">




  


  <script id="google_analytics">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-35644871-2', 'auto');
        ga('send', 'pageview');
  </script>









    <title> Timon Wong </title><!-- hexo-inject:begin --><!-- hexo-inject:end -->
  </head>

  <body><div id="mobile-navbar" class="mobile-navbar">
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="mobile-header-logo">
    <a href="/." class="logo">Timon Wong</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>

<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    
      <a href="/">
        <li class="mobile-menu-item">
          
          
            Home
          
        </li>
      </a>
    
      <a href="/blog/archives/">
        <li class="mobile-menu-item">
          
          
            Archives
          
        </li>
      </a>
    
  </ul>
</nav>

    <div class="container" id="mobile-panel">
      <header id="header" class="header"><div class="logo-wrapper">
  <a href="/." class="logo-text">Timon Wong</a>
</div>

<nav class="site-navbar">
  
    <ul id="menu" class="menu">
      
        <li class="menu-item">
          <a class="menu-item-link" href="/">
            
            
              Home
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/blog/archives/">
            
            
              Archives
            
          </a>
        </li>
      
    </ul>
  
</nav>

      </header>

      <main id="main" class="main">
        <div class="content-wrapper">
          <div id="content" class="content">
            
  <section id="posts" class="posts">
    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/blog/2014/05/16/use-fpm-to-create-python-rpm-packages/">使用 FPM 创建 Python 的 RPM 包</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2014-05-16
        </span>
        
          <div class="post-category">
            
              <a href="/blog/categories/it/">IT</a>
            
          </div>
        
        
      </div>
    </header>

    
    


    <div class="post-content">
      
        
        

        
          <p>生成 RPM 包太麻烦了，最近知道了一个名为 <a href="https://github.com/jordansissel/fpm" target="_blank" rel="external">FPM</a> 的神器，在此记录一下。</p>
<h2 id="安装-FPM"><a href="#安装-FPM" class="headerlink" title="安装 FPM"></a>安装 FPM</h2><p><strong>NOTE:</strong> 测试系统为 RedHat 系的 CentOS 6.3，编译 Python 2.7.6 的 RPM 包。</p>
<h3 id="安装-Ruby"><a href="#安装-Ruby" class="headerlink" title="安装 Ruby"></a>安装 Ruby</h3><p>由于 <a href="https://github.com/jordansissel/fpm" target="_blank" rel="external">FPM</a> 使用 <code>Ruby</code> 写成，因此系统中需要安装 <code>Ruby</code> 的运行环境（这里 <code>gem</code> 的源改为了 taobao 的镜像）：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># Install ruby dependencies</span></div><div class="line">yum -y install ruby rubygems ruby-devel</div><div class="line"><span class="comment"># Use taobao repo for ruby gems</span></div><div class="line">gem sources <span class="_">-a</span> http://ruby.taobao.org/</div><div class="line"><span class="comment"># Remove origin repo from ruby gems</span></div><div class="line">gem sources --remove http://rubygems.org/</div></pre></td></tr></table></figure>
<h3 id="通过-Gem-安装-FPM"><a href="#通过-Gem-安装-FPM" class="headerlink" title="通过 Gem 安装 FPM"></a>通过 Gem 安装 FPM</h3><p>在 <code>Ruby</code> 安装完成后，就可以使用 <code>gem</code> 安装 <a href="https://github.com/jordansissel/fpm" target="_blank" rel="external">FPM</a> 了：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># Install fpm</span></div><div class="line">gem install fpm</div></pre></td></tr></table></figure>
<p>Good.</p>
<h2 id="设置编译环境"><a href="#设置编译环境" class="headerlink" title="设置编译环境"></a>设置编译环境</h2><p>在编译 Python 之前，需要安装开发工具和库:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># Install EPEL repository</span></div><div class="line">wget http://dl.fedoraproject.org/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm</div><div class="line">wget http://rpms.famillecollet.com/enterprise/remi-release-6.rpm</div><div class="line">rpm -Uvh remi-release-6*.rpm epel-release-6*.rpm</div><div class="line"></div><div class="line"><span class="comment"># Install build toolchain</span></div><div class="line">yum -y groupinstall <span class="string">"Development tools"</span></div><div class="line">yum -y install openssl-devel readline-devel bzip2-devel sqlite-devel zlib-devel ncurses-devel db4-devel expat-devel</div></pre></td></tr></table></figure>
<h2 id="编译并创建-Python-的-RPM-包"><a href="#编译并创建-Python-的-RPM-包" class="headerlink" title="编译并创建 Python 的 RPM 包"></a>编译并创建 Python 的 RPM 包</h2><p><a href="https://github.com/jordansissel/fpm" target="_blank" rel="external">FPM</a> 的使用比较简单，可以参考 <a href="https://github.com/jordansissel/fpm" target="_blank" rel="external">FPM</a> 的 <a href="https://github.com/jordansissel/fpm/wiki" target="_blank" rel="external">使用说明</a>。</p>
<p>首先，下载 Python-2.7.6 的源码包并解压：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">curl --progress-bar -LO http://mirrors.sohu.com/python/2.7.6/Python-2.7.6.tgz</div><div class="line">tar xf Python-2.7.6.tgz</div></pre></td></tr></table></figure>
<p>第二步，编译 Python-2.7.6</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> Python-2.7.6.tgz</div><div class="line"></div><div class="line"><span class="comment"># Python2.7编译安装后会安装到这个目录，方便打包</span></div><div class="line"><span class="built_in">export</span> INTERMEDIATE_INSTALL_DIR=/tmp/installdir-Python-2.7.6</div><div class="line"><span class="comment"># RPM包安装后Python2.7的目录</span></div><div class="line"><span class="built_in">export</span> INSTALL_DIR=/usr/<span class="built_in">local</span></div><div class="line"></div><div class="line">LDFLAGS=<span class="string">"-Wl,-rpath=<span class="variable">$&#123;INSTALL_DIR&#125;</span>/lib <span class="variable">$&#123;LDFLAGS&#125;</span>"</span> \</div><div class="line">            ./configure --prefix=<span class="variable">$&#123;INSTALL_DIR&#125;</span> --enable-unicode=ucs4 \</div><div class="line">                --enable-shared --enable-ipv6</div><div class="line">make</div><div class="line">make install DESTDIR=<span class="variable">$&#123;INTERMEDIATE_INSTALL_DIR&#125;</span></div></pre></td></tr></table></figure>
<p>第三步，使用 <a href="https://github.com/jordansissel/fpm" target="_blank" rel="external">FPM</a> 创建 RPM 包：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 注意之前导出 INTERMEDIATE_INSTALL_DIR 和 INSTALL_DIR 这两个环境变量，这里还要使用</span></div><div class="line">fpm <span class="_">-s</span> dir -t <span class="_">-f</span> rpm -n python27 -v <span class="string">'2.7.6'</span> \</div><div class="line">    <span class="_">-d</span> <span class="string">'openssl'</span> \</div><div class="line">    <span class="_">-d</span> <span class="string">'bzip2'</span> \</div><div class="line">    <span class="_">-d</span> <span class="string">'zlib'</span> \</div><div class="line">    <span class="_">-d</span> <span class="string">'expat'</span> \</div><div class="line">    <span class="_">-d</span> <span class="string">'db4'</span> \</div><div class="line">    <span class="_">-d</span> <span class="string">'sqlite'</span> \</div><div class="line">    <span class="_">-d</span> <span class="string">'ncurses'</span> \</div><div class="line">    <span class="_">-d</span> <span class="string">'readline'</span> \</div><div class="line">    --directories=<span class="variable">$&#123;INSTALL_DIR&#125;</span>/lib/python2.7/ \</div><div class="line">    --directories=<span class="variable">$&#123;INSTALL_DIR&#125;</span>/include/python2.7/ \</div><div class="line">    -C <span class="variable">$&#123;INTERMEDIATE_INSTALL_DIR&#125;</span> .</div></pre></td></tr></table></figure>
<h2 id="Bonus-Time"><a href="#Bonus-Time" class="headerlink" title="Bonus Time"></a>Bonus Time</h2><p>包含以下内容：</p>
<ul>
<li>自动下载、编译、打包 Python RPM 包的 Makefile；</li>
<li>自动下载、编译、打包 virtualenv、pip、supervisor 等 Python 库和工具的 RPM 包。</li>
</ul>
<p>GitHub 项目地址：<a href="https://github.com/timonwong/python27-rpm" target="_blank" rel="external">python27-rpm</a></p>

        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/blog/2014/05/15/rabbitmq-note-3-pika-send-large-message/">RabbitMQ笔记（三）: Pika客户端（Python）发送大尺寸消息的问题</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2014-05-15
        </span>
        
          <div class="post-category">
            
              <a href="/blog/categories/it/">IT</a>
            
          </div>
        
        
      </div>
    </header>

    
    


    <div class="post-content">
      
        
        

        
          <h2 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h2><p>这个问题存在很久了，现象就是使用 <a href="https://pypi.python.org/pypi/pika/" target="_blank" rel="external">Pika</a> 库的客户端在发送大尺寸消息后，RabbitMQ
没有收到，Consumer 那里会认为消息已丢失。</p>
<p><strong>NOTE:</strong> 即使在本文写时的最新版(v0.9.13)依然存在这个问题。</p>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>因为网络状态很好，所以没有考虑网络的错误，直接考虑<a href="https://pypi.python.org/pypi/pika/" target="_blank" rel="external">Pika</a>库的问题。</p>
<p>那么第一步就是把 <a href="https://pypi.python.org/pypi/pika/" target="_blank" rel="external">Pika</a> 的代码拿来读一遍，主要看它是怎么发送消息的，经过一番探索，找到了
<code>pika/adapters/base_connection.py</code> 这个文件，来看看里面的内容：</p>
<figure class="highlight python"><figcaption><span>pika/adapters/base_connection.py</span><a href="https://github.com/pika/pika/blob/0.9.13/pika/adapters/base_connection.py#L329" target="_blank" rel="external">link</a></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">_handle_write</span><span class="params">(self)</span>:</span></div><div class="line">    <span class="string">"""Handle any outbound buffer writes that need to take place."""</span></div><div class="line">    total_written = <span class="number">0</span></div><div class="line">    <span class="keyword">if</span> self.outbound_buffer:</div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            bytes_written = self.socket.send(self.outbound_buffer.popleft())</div><div class="line">        <span class="keyword">except</span> socket.timeout:</div><div class="line">            <span class="keyword">raise</span></div><div class="line">        <span class="keyword">except</span> socket.error, error:</div><div class="line">            <span class="keyword">return</span> self._handle_error(error)</div><div class="line">        total_written += bytes_written</div><div class="line">    <span class="keyword">return</span> total_written</div></pre></td></tr></table></figure>
<p>看出问题了吗？</p>
<p>来看看<code>socket.send</code>的文档吧：</p>
<blockquote><p>Send data to the socket. The socket must be connected to a remote socket. The optional flags argument has the same meaning as for recv() above. Returns the number of bytes sent. Applications are responsible for checking that all data has been sent; if only some of the data was transmitted, the application needs to attempt delivery of the remaining data. For further information on this concept, consult the Socket Programming HOWTO.</p>
<footer><strong>Python Docs</strong><cite><a href="https://docs.python.org/2/library/socket.html#socket.socket.send" target="_blank" rel="external">socket.send</a></cite></footer></blockquote>
<p>问题就是，没有检查 <code>socket.send</code> 的返回值，由于 <code>socket.send</code> 返回实际发送的直接个数，可能会小于期望（在这里是
<code>self.outbound_buffer.popleft()</code>）。</p>
<p>由于 <code>socket.send</code> 可能没有将数据发送完成就返回了，造成了消息丢失的情况。</p>
<p>本来想自己修的，看了一眼 <a href="https://pypi.python.org/pypi/pika/" target="_blank" rel="external">Pika</a> 的 <code>master</code> 分支，已经修正了（一次保证将一个帧(Frame)发送完成）：</p>
<figure class="highlight python"><figcaption><span>pika/adapters/base_connection.py</span><a href="https://github.com/pika/pika/blob/master/pika/adapters/base_connection.py#L354" target="_blank" rel="external">link</a></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">_handle_write</span><span class="params">(self)</span>:</span></div><div class="line">    <span class="string">"""Handle any outbound buffer writes that need to take place."""</span></div><div class="line">    bytes_written = <span class="number">0</span></div><div class="line">    <span class="keyword">if</span> self.outbound_buffer:</div><div class="line">        frame = self.outbound_buffer.popleft()</div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            self.socket.sendall(frame)</div><div class="line">            bytes_written = len(frame)</div><div class="line">        <span class="keyword">except</span> socket.timeout:</div><div class="line">            <span class="keyword">raise</span></div><div class="line">        <span class="keyword">except</span> socket.error <span class="keyword">as</span> error:</div><div class="line">            <span class="keyword">return</span> self._handle_error(error)</div><div class="line">    <span class="keyword">return</span> bytes_written</div></pre></td></tr></table></figure>
<p>呵呵……</p>
<h2 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h2><ol>
<li>自行打补丁；</li>
<li>使用 <code>git</code> 上的 Pika: <code>pip install git+https://github.com/pika/pika.git</code>；</li>
<li>不用 <a href="https://pypi.python.org/pypi/pika/" target="_blank" rel="external">Pika</a>, 换其它的，比如 <a href="http://kombu.readthedocs.org/" target="_blank" rel="external">Kombu</a>。</li>
</ol>
<p>我现在不用 <a href="https://pypi.python.org/pypi/pika/" target="_blank" rel="external">Pika</a> 了，用 <a href="http://kombu.readthedocs.org/" target="_blank" rel="external">Kombu</a>。</p>
<p><strong>PS:</strong> <a href="https://pypi.python.org/pypi/pika/" target="_blank" rel="external">Pika</a> 的发布也太不积极了，都怎么久了还不发新版本。</p>

        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/blog/2014/05/14/resolve-302-redirection-on-github-pages/">解决GitHub Pages的302转向问题</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2014-05-14
        </span>
        
          <div class="post-category">
            
              <a href="/blog/categories/it/">IT</a>
            
          </div>
        
        
      </div>
    </header>

    
    


    <div class="post-content">
      
        
        

        
          <h2 id="起因"><a href="#起因" class="headerlink" title="起因"></a>起因</h2><p><strong>NOTE:</strong> 如果给GitHub Pages使用的是子域名，按照<a href="https://help.github.com/articles/setting-up-a-custom-domain-with-github-pages" target="_blank" rel="external">GitHub Pages文档</a>配置，不会出现该问题。</p>
<p>由于我在GitHub Pages上的搭的博客使用了<code>theo.im</code>这个根域名(Apex Domain)，在按照
<a href="https://help.github.com/articles/setting-up-a-custom-domain-with-github-pages" target="_blank" rel="external">GitHub Pages文档</a>上提供的信息，对<code>theo.im</code>设置了<strong>A记录</strong>，但是通过执行命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl -I http://theo.im/sitemap.xml</div></pre></td></tr></table></figure>
<p>发现得到的是302转向，不符合Sitemap协议的要求：</p>
<blockquote><p>A successful request will return an HTTP 200 response code; if you receive a different response, you should resubmit your request. The HTTP 200 response code only indicates that the search engine has received your Sitemap, not that the Sitemap itself or the URLs contained in it were valid.</p>
<footer><strong>sitemaps.org</strong><cite><a href="http://www.sitemaps.org/protocol.html" target="_blank" rel="external">Sitemaps Protocol</a></cite></footer></blockquote>
<h2 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h2><p>通过搜索，我发现需要使用<strong>ALIAS记录</strong>解析根域名，但是由于我之前使用的是<a href="http://dnspod.cn" target="_blank" rel="external">DNSPod</a>
的服务，不支持<strong>ALIAS记录</strong>，因此决定换加DNS域名解析商。</p>
<p>经过一番搜寻，找到了两家支持<strong>ALIAS记录</strong>的DNS域名解析商：</p>
<ol>
<li><a href="https://dnsimple.com/" target="_blank" rel="external">DNSimple</a>: 全收费服务</li>
<li><a href="https://pointhq.com/" target="_blank" rel="external">PointDNS</a>: 有免费的开发者账户</li>
</ol>
<p>本着能用收费不用免费的原则，因此我选择了 <a href="https://dnsimple.com/" target="_blank" rel="external">DNSimple</a> 来解析我的域名 (゜o゜(☆○=(-_-)</p>
<p><img src="https://theo-im-1255089908.cos.ap-chengdu.myqcloud.com/images/github-pages-dns-buybuybuy.jpg" alt=""></p>
<p>OK，万文不如一图：</p>
<p><img src="https://theo-im-1255089908.cos.ap-chengdu.myqcloud.com/images/github-pages-dns-setup.png" alt=""></p>
<p>最后，运行 <code>dig theo.im +nostats +nocomments +nocmd</code> 检查DNS是否生效：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">; &lt;&lt;&gt;&gt; DiG 9.8.2rc1-RedHat-9.8.2-0.23.rc1.el6_5.1 &lt;&lt;&gt;&gt; theo.im +nostats +nocomments +nocmd</div><div class="line">;; global options: +cmd</div><div class="line">;theo.im.           IN  A</div><div class="line">theo.im.        3600    IN  A   199.27.79.133</div></pre></td></tr></table></figure>

        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/blog/2014/05/13/rabbitmq-note-2-about-simultaneous-connections/">RabbitMQ笔记（二）: 并发连接数</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2014-05-13
        </span>
        
          <div class="post-category">
            
              <a href="/blog/categories/it/">IT</a>
            
          </div>
        
        
      </div>
    </header>

    
    


    <div class="post-content">
      
        
        

        
          <h2 id="概要"><a href="#概要" class="headerlink" title="概要"></a>概要</h2><p>对于服务器来说，并发连接数一直是一个需要考量的问题，因此在这里做一个简单的测试。</p>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>在测试前，需要准备一个客户端环境，本文的环境是:</p>
<ul>
<li>CentOS 6.3</li>
<li>Python 2.7.6<ul>
<li><a href="http://kombu.readthedocs.org/" target="_blank" rel="external">Kombu</a></li>
</ul>
</li>
</ul>
<p><strong>NOTE:</strong> 下文中的 IP 地址 <code>10.10.0.70</code> 为 RabbitMQ 服务器的 IP 地址</p>
<h3 id="测试-耗尽-rabbitmq-的-socket-descriptors"><a href="#测试-耗尽-rabbitmq-的-socket-descriptors" class="headerlink" title="测试: 耗尽 rabbitmq 的 socket descriptors"></a>测试: 耗尽 rabbitmq 的 socket descriptors</h3><p>首先, 编写一个脚本:</p>
<figure class="highlight python"><figcaption><span>exhaust_socket_descriptors.py</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/env python</span></div><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"><span class="keyword">import</span> os</div><div class="line"><span class="keyword">import</span> logging</div><div class="line"></div><div class="line"><span class="keyword">import</span> config</div><div class="line"></div><div class="line">logging.basicConfig(format=<span class="string">'%(asctime)s - %(name)s - %(levelname)s - %(message)s'</span>,</div><div class="line">                    level=logging.INFO)</div><div class="line">LOG = logging.getLogger(os.path.basename(__file__))</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></div><div class="line">    connections = []</div><div class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">        LOG.info(<span class="string">"Try to establish a new rabbit connection..."</span>)</div><div class="line">        connection = config.get_connection()</div><div class="line">        connection.connect()</div><div class="line">        connections.append(connection)</div><div class="line">        LOG.info(<span class="string">"[%d] connections"</span>, len(connections))</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    main()</div></pre></td></tr></table></figure>
<p>在<strong>客户端</strong>执行<code>exhaust_socket_descriptors.py</code>, 会看到如下输出:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">...前略...</div><div class="line">2014-05-13 10:45:17,477 - exhaust_socket_descriptors.py - INFO - Try to establish a new rabbit connection...</div><div class="line">2014-05-13 10:45:17,489 - exhaust_socket_descriptors.py - INFO - [826] connections</div><div class="line">2014-05-13 10:45:17,489 - exhaust_socket_descriptors.py - INFO - Try to establish a new rabbit connection...</div><div class="line">2014-05-13 10:45:17,502 - exhaust_socket_descriptors.py - INFO - [827] connections</div><div class="line">2014-05-13 10:45:17,502 - exhaust_socket_descriptors.py - INFO - Try to establish a new rabbit connection...</div><div class="line">2014-05-13 10:45:17,516 - exhaust_socket_descriptors.py - INFO - [828] connections</div><div class="line">2014-05-13 10:45:17,516 - exhaust_socket_descriptors.py - INFO - Try to establish a new rabbit connection...</div><div class="line">2014-05-13 10:45:17,528 - exhaust_socket_descriptors.py - INFO - [829] connections</div><div class="line">2014-05-13 10:45:17,529 - exhaust_socket_descriptors.py - INFO - Try to establish a new rabbit connection...</div></pre></td></tr></table></figure>
<p>看到似乎是连接耗尽了，在<strong>服务器端</strong>上确认一下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@localhost vagrant]# rabbitmqctl status | grep sockets_</div><div class="line">      &#123;sockets_limit,829&#125;,</div><div class="line">      &#123;sockets_used,829&#125;]&#125;,</div></pre></td></tr></table></figure>
<p><code>sockets_used</code> 与 <code>sockets_limit</code> 相同，可以确认 socket descriptors 耗尽了，因此客户端成功新连接，卡在
<code>Try to establish a new rabbit connection...</code> 处。但是问题在于，<strong>为什么不超时？</strong></p>
<p>在<strong>客户端</strong>中检查一下TCP连接个数:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]# netstat -atn | grep 10.10.0.70:5672 | wc -l</div><div class="line">830</div></pre></td></tr></table></figure>
<p>可以得出，socket连接数是830，大于服务器端的<code>sockets_limit</code></p>
<p>继续，在<strong>客户端</strong>中，检查一下TCP连接状态：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]# netstat -atn | grep 10.10.0.70:5672  | awk &apos;&#123;print $6&#125;&apos; | uniq</div><div class="line">ESTABLISHED</div></pre></td></tr></table></figure>
<p><strong>全部都是ESTABLISHED状态</strong>，因此服务器仅仅是阻塞了新连接，而不是拒绝新连接。这样，就产生了一个问题：</p>
<p>如果是使用 <a href="http://clusterlabs.org/" target="_blank" rel="external">HAProxy</a> 等工具搭建的集群，由于<strong>服务器依然会接受新连接</strong>，因此 <a href="http://clusterlabs.org/" target="_blank" rel="external">HAProxy</a> 不会认为节点已Down，<strong>最终会导致整个集群卡住</strong>；</p>
<h3 id="Bug"><a href="#Bug" class="headerlink" title="Bug"></a>Bug</h3><p>当 RabbitMQ 的 <code>sockets_used</code> 达到 <code>sockets_limits</code> 时候（连接数耗尽时），最终即使是 Consumer
也会全部阻塞，只有在 <code>sockets_used &lt; sockets_limit</code> 时（释放部分连接后），才会恢复。</p>
<p>参见以下连接获取更多信息: <a href="http://markmail.org/message/r4yhvqc7vgfljpao" target="_blank" rel="external">http://markmail.org/message/r4yhvqc7vgfljpao</a></p>
<h2 id="Workaround-增加File-Socket-Descriptors个数"><a href="#Workaround-增加File-Socket-Descriptors个数" class="headerlink" title="Workaround: 增加File/Socket Descriptors个数"></a>Workaround: 增加File/Socket Descriptors个数</h2><p>通过官方(包括EPEL)的 <code>deb</code>, <code>rpm</code> 包安装的启动脚本，都会在<code>rabbitmq-server</code>
启动前 <code>source</code> 一次 <code>/etc/default/rabbitmq-server</code> 文件，因此我们可以在该文件中增加最大允许的
File/Socket Descriptors 个数。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">echo</span> <span class="string">'ulimit -n 102400'</span> &gt; /etc/default/rabbitmq-server</div></pre></td></tr></table></figure>
<p>最后，重启 RabbitMQ 服务器以生效该设置：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">service rabbitmq-server restart</div></pre></td></tr></table></figure>
<h2 id="Updated"><a href="#Updated" class="headerlink" title="Updated"></a>Updated</h2><h3 id="May-17-2014"><a href="#May-17-2014" class="headerlink" title="May 17, 2014"></a>May 17, 2014</h3><ul>
<li>更新 Bug 说明 (RabbitMQ <code>bug26180</code>)</li>
</ul>

        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/blog/2014/05/13/rabbitmq-note-1-setup-experimental-rabbitmq-environment-using-vagrant/">RabbitMQ笔记（一）: 通过Vagrant建立一个RabbitMQ服务器实验环境</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2014-05-13
        </span>
        
          <div class="post-category">
            
              <a href="/blog/categories/it/">IT</a>
            
          </div>
        
        
      </div>
    </header>

    
    


    <div class="post-content">
      
        
        

        
          <h2 id="安装Vagrant"><a href="#安装Vagrant" class="headerlink" title="安装Vagrant"></a>安装Vagrant</h2><p>在<a href="http://vagrantup.com" target="_blank" rel="external">官方网站</a>上，下载并安装Vagrant</p>
<p><strong>NOTE</strong>: Vagrant 1.6版本对<code>CentOS</code>的guest支持不好，不能正确设置网络连接，需要升级到最新版或打上下面这个补丁: <a href="https://github.com/cammoraton/vagrant/commit/1e4584cde51765972af41cd48fc0409756a8fd59" target="_blank" rel="external">Fix issue reported at mitchellh#3649</a></p>
<h2 id="下载并导入CentOS-6-3-Box"><a href="#下载并导入CentOS-6-3-Box" class="headerlink" title="下载并导入CentOS 6.3 Box"></a>下载并导入CentOS 6.3 Box</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">vagrant box add --name centos63 <span class="string">'https://s3.amazonaws.com/itmat-public/centos-6.3-chef-10.14.2.box'</span></div></pre></td></tr></table></figure>
<h2 id="创建Vagrantfile"><a href="#创建Vagrantfile" class="headerlink" title="创建Vagrantfile"></a>创建Vagrantfile</h2><p><code>Vagrantfile</code> 文件内容如下:</p>
<figure class="highlight ruby"><figcaption><span>Vagrantfile</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># -*- mode: ruby -*-</span></div><div class="line"><span class="comment"># vi: set ft=ruby :</span></div><div class="line"></div><div class="line"><span class="comment"># Vagrantfile API/syntax version. Don't touch unless you know what you're doing!</span></div><div class="line">VAGRANTFILE_API_VERSION = <span class="string">"2"</span></div><div class="line"></div><div class="line">Vagrant.configure(VAGRANTFILE_API_VERSION) <span class="keyword">do</span> <span class="params">|config|</span></div><div class="line">  config.vm.box = <span class="string">"centos63"</span></div><div class="line"></div><div class="line">  <span class="comment"># 一个Host-Only的Network, IP地址可以自定义, 方便访问</span></div><div class="line">  config.vm.network <span class="symbol">:private_network</span>, <span class="symbol">ip:</span> <span class="string">"10.10.0.70"</span>, <span class="symbol">netmask:</span> <span class="string">"255.255.255.0"</span></div><div class="line"></div><div class="line">  <span class="comment"># config.vm.synced_folder "../", "/vagrant"</span></div><div class="line"></div><div class="line">  config.vm.provider <span class="symbol">:virtualbox</span> <span class="keyword">do</span> <span class="params">|vb|</span></div><div class="line">    <span class="comment"># 调节虚拟机CPU个数</span></div><div class="line">    vb.customize [<span class="string">"modifyvm"</span>, <span class="symbol">:id</span>, <span class="string">"--cpus"</span>, <span class="string">"2"</span>]</div><div class="line">    <span class="comment"># 调节虚拟机内存大小</span></div><div class="line">    vb.customize [<span class="string">"modifyvm"</span>, <span class="symbol">:id</span>, <span class="string">"--memory"</span>, <span class="string">"2048"</span>]</div><div class="line">    vb.customize [<span class="string">"modifyvm"</span>, <span class="symbol">:id</span>, <span class="string">"--natdnshostresolver1"</span>, <span class="string">"on"</span>]</div><div class="line">    vb.customize [<span class="string">"setextradata"</span>, <span class="symbol">:id</span>, <span class="string">"VBoxInternal2/SharedFoldersEnableSymlinksCreate/vagrant"</span>, <span class="string">"1"</span>]</div><div class="line">  <span class="keyword">end</span></div><div class="line"></div><div class="line">  <span class="comment"># 自动安装脚本</span></div><div class="line">  config.vm.provision <span class="symbol">:shell</span>, <span class="symbol">path:</span> <span class="string">"provision.sh"</span></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure>
<p>为了简化安装，提供一个用于自动安装的脚本<code>provision.sh</code>，文件内容如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/usr/bin/env bash</span></div><div class="line"></div><div class="line"><span class="comment"># Disable yum fastestmirror plugin</span></div><div class="line">sed -i.backup <span class="string">'s/^enabled=1/enabled=0/'</span> /etc/yum/pluginconf.d/fastestmirror.conf</div><div class="line"><span class="comment"># Change yum mirror (163)</span></div><div class="line">mv /etc/yum.repos.d/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo.backup</div><div class="line">wget -O /etc/yum.repos.d/CentOS-Base-163.repo http://mirrors.163.com/.help/CentOS6-Base-163.repo</div><div class="line">yum makecache</div><div class="line">yum update</div><div class="line"></div><div class="line"><span class="comment"># Install EPEL repository</span></div><div class="line">wget http://dl.fedoraproject.org/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm</div><div class="line">wget http://rpms.famillecollet.com/enterprise/remi-release-6.rpm</div><div class="line">rpm -Uvh remi-release-6*.rpm epel-release-6*.rpm</div><div class="line"></div><div class="line"><span class="comment"># Install and start rabbitmq-server</span></div><div class="line">yum -y install rabbitmq-server</div><div class="line"></div><div class="line"><span class="comment">## Automatically start</span></div><div class="line">chkconfig rabbitmq-server on</div><div class="line"></div><div class="line"><span class="comment">## Create a sample config and enable guest user remote access</span></div><div class="line"><span class="built_in">echo</span> &gt; /etc/rabbitmq/rabbitmq.config &lt;&lt;EOF</div><div class="line">[</div><div class="line">  &#123;rabbit, [</div><div class="line">    &#123;loopback_users, []&#125;</div><div class="line">  ]&#125;</div><div class="line">].</div><div class="line">EOF</div><div class="line"></div><div class="line"><span class="comment">## Enable magement plugin</span></div><div class="line">/usr/lib/rabbitmq/bin/rabbitmq-plugins <span class="built_in">enable</span> rabbitmq_management</div><div class="line"></div><div class="line"><span class="comment">## Start rabbitmq-server</span></div><div class="line">service rabbitmq-server start</div><div class="line"></div><div class="line"><span class="comment"># Disable iptables</span></div><div class="line">service iptables stop</div><div class="line">chkconfig iptables off</div></pre></td></tr></table></figure>
<h2 id="启动虚拟机"><a href="#启动虚拟机" class="headerlink" title="启动虚拟机"></a>启动虚拟机</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">vagrant up</div></pre></td></tr></table></figure>
<h2 id="使用SSH连接到虚拟机"><a href="#使用SSH连接到虚拟机" class="headerlink" title="使用SSH连接到虚拟机"></a>使用SSH连接到虚拟机</h2><p>使用命令(如果支持的话):</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">vagrant ssh</div></pre></td></tr></table></figure>
<p>或使用SSH工具，例如 <a href="http://www.netsarang.com/products/xsh_overview.html" target="_blank" rel="external">XShell</a>, <a href="http://www.chiark.greenend.org.uk/~sgtatham/putty/download.html" target="_blank" rel="external">PuTTY</a> 等工具，连接到 <code>10.10.0.70:22</code> (IP在之前 <code>Vagrantfile</code> 中定义)</p>
<h2 id="停止虚拟机"><a href="#停止虚拟机" class="headerlink" title="停止虚拟机"></a>停止虚拟机</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">vagrant halt</div></pre></td></tr></table></figure>

        
      
    </div>

    

    

  </article>

    
  </section>

  
  <nav class="pagination">
    
      <a class="prev" href="/blog/page/2/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text">Prev</span>
      </a>
    
    
      <a class="next" href="/blog/page/4/">
        <span class="next-text">Next</span>
        <i class="iconfont icon-right"></i>
      </a>
    
  </nav>


          </div>
          

        </div>
      </main>

      <footer id="footer" class="footer">

  <div class="social-links">
    
      
        
          <a href="mailto:timon86.wang@gmail.com" class="iconfont icon-email" title="email"></a>
        
      
    
      
    
      
        
          <a href="https://twitter.com/timonwong" class="iconfont icon-twitter" title="twitter"></a>
        
      
    
      
    
      
    
      
    
      
        
          <a href="https://github.com/timonwong" class="iconfont icon-github" title="github"></a>
        
      
    
      
    
      
    
      
    
      
    
      
    
      
    
    
    
      <a href="/atom.xml" class="iconfont icon-rss" title="rss"></a>
    
  </div>



<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://hexo.io/">Hexo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/ahonn/hexo-theme-even">Even</a>
  </span>

  <span class="copyright-year">
    
    &copy; 
     
      2012 - 
    
    2018

    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">Timon Wong</span>
  </span>
</div>

      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>

    


    
  





  
    <script type="text/javascript" src="https://cdn.staticfile.org/jquery/3.1.1/jquery.min.js"></script>
  

  
    <script type="text/javascript" src="https://cdn.staticfile.org/slideout/1.0.1/slideout.min.js"></script>
  

  
    <script type="text/javascript" src="https://cdn.staticfile.org/fancybox/2.1.5/jquery.fancybox.pack.js"></script>
  


<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      processEscapes: true,
      inlineMath: [ ['$','$'], ['\\(','\\)'] ],
      skipTags: [ 'script', 'noscript', 'style', 'textarea', 'pre', 'code' ]
    }
  });
</script>
<script type="text/javascript" async src="https://cdn.staticfile.org/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML" integrity="sha384-Ra6zh6uYMmH5ydwCqqMoykyf1T/+ZcnOQfFPhDrp2kI4OIxadnhsvvA2vv9A7xYv" crossorigin="anonymous"></script>

    <script type="text/javascript" src="/js/src/even.js?v=2.6.0"></script>
<script type="text/javascript" src="/js/src/bootstrap.js?v=2.6.0"></script><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->

  </body>
</html>
