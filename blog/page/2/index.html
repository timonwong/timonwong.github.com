<!DOCTYPE html>
<html lang="en">
  <head>
    
<!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">















  <link rel="alternate" href="/atom.xml" title="Timon Wong">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=2.6.0" />



<link rel="canonical" href="http://theo.im/blog/page/2/"/>


<link rel="stylesheet" type="text/css" href="/css/style.css?v=2.6.0" />



  <link rel="stylesheet" type="text/css" href="/lib/fancybox/jquery.fancybox.css" />




  


  <script id="google_analytics">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-35644871-2', 'auto');
        ga('send', 'pageview');
  </script>


  <script id="baidu_push">
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>









    <title> Timon Wong </title><!-- hexo-inject:begin --><!-- hexo-inject:end -->
  </head>

  <body><div id="mobile-navbar" class="mobile-navbar">
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="mobile-header-logo">
    <a href="/." class="logo">Timon Wong</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>

<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    
      <a href="/">
        <li class="mobile-menu-item">
          
          
            Home
          
        </li>
      </a>
    
      <a href="/blog/archives/">
        <li class="mobile-menu-item">
          
          
            Archives
          
        </li>
      </a>
    
  </ul>
</nav>

    <div class="container" id="mobile-panel">
      <header id="header" class="header"><div class="logo-wrapper">
  <a href="/." class="logo-text">Timon Wong</a>
</div>

<nav class="site-navbar">
  
    <ul id="menu" class="menu">
      
        <li class="menu-item">
          <a class="menu-item-link" href="/">
            
            
              Home
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/blog/archives/">
            
            
              Archives
            
          </a>
        </li>
      
    </ul>
  
</nav>

      </header>

      <main id="main" class="main">
        <div class="content-wrapper">
          <div id="content" class="content">
            
  <section id="posts" class="posts">
    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/blog/2014/08/05/VirtualBox-error-launching-vm-instance-in-supR3HardenedWinReSpawn/">VirtualBox与杀毒软件冲突导致虚拟机无法启动: 错误 "supR3HardenedWinReSpawn"</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2014-08-05
        </span>
        
          <div class="post-category">
            
              <a href="/blog/categories/miscellaneous/">Miscellaneous</a>
            
          </div>
        
        
      </div>
    </header>

    
    


    <div class="post-content">
      
        
        

        
          <p>今天在公司机器上装了 VirtualBox (版本 4.3.14) 和 Vagrant, 在运行 <code>vagrant up</code> 后总是提示虚拟机不能启动的错误。打开 VirtualBox 然后手动启动虚拟机发现如下错误框：</p>
<p><img src="http://theo-im.qiniudn.com/images/virtualbox-error.png" alt=""></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">---------------------------</div><div class="line">VirtualBox - Error In supR3HardenedWinReSpawn</div><div class="line">---------------------------</div><div class="line">Error relaunching VirtualBox VM process: 5</div><div class="line">Command line: &apos;81954AF5-4D2F-31EB-A142-B7AF187A1C41-suplib-2ndchild --comment Work_default_1407215688716_8404 --startvm 93cdc421-ae20-49d6-8ca4-6c5570f809cd --no-startvm-errormsgbox&apos; (rc=-104)/&gt;</div><div class="line">---------------------------</div></pre></td></tr></table></figure>
<p>原因:</p>
<ul>
<li>与 Symantec Endpoint Protection 冲突</li>
</ul>
<p>临时解决办法：</p>
<ul>
<li>使用 4.3.12 版本的 VirtualBox，<a href="https://www.virtualbox.org/wiki/Download_Old_Builds_4_3" target="_blank" rel="external">点击这里下载</a>.</li>
</ul>
<p><strong>NOTE</strong> 降级 VirtualBox 后需要重新启动计算机</p>
<p>另外可以<a href="https://forums.virtualbox.org/viewtopic.php?f=6&amp;t=62615" target="_blank" rel="external">参考VirtualBox 论坛的讨论</a></p>

        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/blog/2014/07/21/Printing-stacktrace-in-Go/">在 Go 中获取 stacktrace</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2014-07-21
        </span>
        
          <div class="post-category">
            
              <a href="/blog/categories/it/">IT</a>
            
          </div>
        
        
      </div>
    </header>

    
    


    <div class="post-content">
      
        
        

        
          <figure class="highlight go"><figcaption><span>打印 stacktrace</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">buf := <span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="number">1</span>&lt;&lt;<span class="number">16</span>)</div><div class="line"><span class="comment">// 获取 **所有** goroutine 的 stacktrace</span></div><div class="line">runtime.Stack(buf, <span class="literal">true</span>)</div><div class="line"><span class="comment">// 如果需要获取 **当前** goroutine 的 stacktrace, 第二个参数需要为 `false`</span></div><div class="line">runtime.Stack(buf, <span class="literal">true</span>)</div><div class="line">fmt.Println(<span class="keyword">string</span>(buf))</div></pre></td></tr></table></figure>
<p>太诡异了，居然要指定 buffer 的大小，用起来不方便。虽然可以给个“足够大” buffer 用来容纳
stacktrace，但是什么是“足够大”？</p>
<p>为了确认 <code>runtime.Stack()</code> 函数的 behavior，需要参考一下 Go 输出 stacktrace 的实现代码。该代码是使用 <a href="https://code.google.com/p/go/source/browse/src/cmd/dist/goc2c.c" target="_blank" rel="external">GOC</a> 写成的。</p>
<blockquote>
<p>A .goc file is a combination of a limited form of Go with C.</p>
</blockquote>
<figure class="highlight go"><figcaption><span>mprof.goc</span><a href="https://code.google.com/p/go/source/browse/src/pkg/runtime/mprof.goc?name" target="_blank" rel="external">link</a></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Stack</span><span class="params">(b Slice, all <span class="keyword">bool</span>)</span> <span class="params">(n <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">    <span class="keyword">uintptr</span> pc, sp;</div><div class="line"></div><div class="line">    <span class="comment">// Stack pointer</span></div><div class="line">    sp = runtime·getcallersp(&amp;b);</div><div class="line">    <span class="comment">// Programer pointer</span></div><div class="line">    pc = (<span class="keyword">uintptr</span>)runtime·getcallerpc(&amp;b);</div><div class="line"></div><div class="line">    <span class="comment">// 如果选择输出所有 goroutine 的 traceback, 挂起所有goroutine,</span></div><div class="line">    <span class="comment">// 在本函数完成后恢复</span></div><div class="line">    <span class="keyword">if</span>(all) &#123;</div><div class="line">        runtime·semacquire(&amp;runtime·worldsema, <span class="literal">false</span>);</div><div class="line">        m-&gt;gcing = <span class="number">1</span>;</div><div class="line">        runtime·stoptheworld();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span>(b.<span class="built_in">len</span> == <span class="number">0</span>)</div><div class="line">        n = <span class="number">0</span>;</div><div class="line">    <span class="keyword">else</span>&#123;</div><div class="line">        <span class="comment">// 重定向输出缓冲, 打印到 `b` 这个buffer里</span></div><div class="line">        g-&gt;writebuf = (<span class="keyword">byte</span>*)b.array;</div><div class="line">        <span class="comment">// buffer具有固定大小, 因此会截断</span></div><div class="line">        g-&gt;writenbuf = b.<span class="built_in">len</span>;</div><div class="line">        <span class="comment">// proc.c: runtime·goroutineheader</span></div><div class="line">        runtime·goroutineheader(g);</div><div class="line">        <span class="comment">// traceback_$&#123;arch&#125;.c</span></div><div class="line">        runtime·traceback(pc, sp, <span class="number">0</span>, g);</div><div class="line">        <span class="keyword">if</span>(all)</div><div class="line">            runtime·tracebackothers(g);</div><div class="line">        n = b.<span class="built_in">len</span> - g-&gt;writenbuf;</div><div class="line">        g-&gt;writebuf = <span class="literal">nil</span>;</div><div class="line">        g-&gt;writenbuf = <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span>(all) &#123;</div><div class="line">        m-&gt;gcing = <span class="number">0</span>;</div><div class="line">        runtime·semrelease(&amp;runtime·worldsema);</div><div class="line">        runtime·starttheworld();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>因为打印到buffer会截断过长的结果，因此可以写一个包装函数：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">StackTrace</span><span class="params">(all <span class="keyword">bool</span>)</span> <span class="title">string</span></span> &#123;</div><div class="line">    <span class="comment">// Reserve 10K buffer at first</span></div><div class="line">    buf := <span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="number">10240</span>)</div><div class="line"></div><div class="line">    <span class="keyword">for</span> &#123;</div><div class="line">        size := runtime.Stack(buf, all)</div><div class="line">        <span class="comment">// The size of the buffer may be not enough to hold the stacktrace,</span></div><div class="line">        <span class="comment">// so double the buffer size</span></div><div class="line">        <span class="keyword">if</span> size == <span class="built_in">len</span>(buf) &#123;</div><div class="line">            buf = <span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="built_in">len</span>(buf)&lt;&lt;<span class="number">1</span>)</div><div class="line">            <span class="keyword">continue</span></div><div class="line">        &#125;</div><div class="line">        <span class="keyword">break</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">string</span>(buf)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>例子可以在这里看到：<a href="http://play.golang.org/p/4ABrCVbH9g" target="_blank" rel="external">Go Playground</a></p>

        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/blog/2014/05/20/use-aliyun-mirror-to-boost-up-download-speed/">使用阿里云镜像服务器</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2014-05-20
        </span>
        
          <div class="post-category">
            
              <a href="/blog/categories/it/">IT</a>
            
          </div>
        
        
      </div>
    </header>

    
    


    <div class="post-content">
      
        
        

        
          <p>最近本机访问 <code>163.com</code> 的 <code>CentOS</code> 镜像比较不稳定，体现在 ping 很低，但是 HTTP
连接很慢，<code>yum</code> 的 <code>fastestmirror</code> 也不太理想，所以一般都禁用之。</p>
<p>发现阿里云的镜像服务器，立马换了，便秘立刻就通了。</p>
<h2 id="yum-镜像"><a href="#yum-镜像" class="headerlink" title="yum 镜像"></a>yum 镜像</h2><h3 id="官方源镜像"><a href="#官方源镜像" class="headerlink" title="官方源镜像"></a>官方源镜像</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 禁用 fastestmirror 插件</span></div><div class="line">sed -i.backup <span class="string">'s/^enabled=1/enabled=0/'</span> /etc/yum/pluginconf.d/fastestmirror.conf</div><div class="line"><span class="comment"># 备份</span></div><div class="line">mv /etc/yum.repos.d/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo.backup</div><div class="line"><span class="comment"># 使用阿里云镜像</span></div><div class="line">wget -O /etc/yum.repos.d/CentOS-Base-aliyun.repo http://mirrors.aliyun.com/repo/Centos-6.repo</div></pre></td></tr></table></figure>
<h3 id="EPEL-镜像"><a href="#EPEL-镜像" class="headerlink" title="EPEL 镜像"></a>EPEL 镜像</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 安装 EPEL 源</span></div><div class="line">wget http://dl.fedoraproject.org/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm</div><div class="line">wget http://rpms.famillecollet.com/enterprise/remi-release-6.rpm</div><div class="line">rpm -Uvh remi-release-6*.rpm epel-release-6*.rpm</div><div class="line"><span class="comment"># 使用阿里云镜像</span></div><div class="line"><span class="keyword">if</span> [[ ! <span class="_">-f</span> /etc/yum.repos.d/epel.repo.backup ]]; <span class="keyword">then</span></div><div class="line">    mv /etc/yum.repos.d/epel.repo /etc/yum.repos.d/epel.repo.backup 2&gt;/dev/null || :</div><div class="line"><span class="keyword">fi</span></div><div class="line"></div><div class="line"><span class="keyword">if</span> [[ ! <span class="_">-f</span> /etc/yum.repos.d/epel-testing.repo.backup ]]; <span class="keyword">then</span></div><div class="line">    mv /etc/yum.repos.d/epel-testing.repo /etc/yum.repos.d/epel-testing.repo.backup 2&gt;/dev/null || :</div><div class="line"><span class="keyword">fi</span></div><div class="line"></div><div class="line">wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-6.repo</div></pre></td></tr></table></figure>
<h2 id="PyPi-镜像"><a href="#PyPi-镜像" class="headerlink" title="PyPi 镜像"></a>PyPi 镜像</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">mkdir -p ~/.pip</div><div class="line">touch ~/.pip/pip.conf</div><div class="line"></div><div class="line">sed -i.backup -r \</div><div class="line">    <span class="string">'s/^index-url\s*=\s*.+$/index-url = http:\/\/mirrors.aliyun.com\/pypi\/simple\//'</span> \</div><div class="line">    ~/.pip/pip.conf</div><div class="line"></div><div class="line"><span class="comment"># If file not changed, write contents back to pip.conf</span></div><div class="line">diff <span class="string">"~/.pip/pip.conf"</span> <span class="string">"~/.pip/pip.conf.backup"</span> &amp;&gt; /dev/null</div><div class="line"></div><div class="line"><span class="keyword">if</span> [ $? <span class="_">-eq</span> 0 ]; <span class="keyword">then</span></div><div class="line">cat &gt; ~/.pip/pip.conf &lt;&lt;EOF</div><div class="line">[global]</div><div class="line">index-url = http://mirrors.aliyun.com/pypi/simple/</div><div class="line">EOF</div><div class="line"><span class="keyword">fi</span></div></pre></td></tr></table></figure>
<h2 id="RubyGems-镜像"><a href="#RubyGems-镜像" class="headerlink" title="RubyGems 镜像"></a>RubyGems 镜像</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">gem <span class="built_in">source</span> -r https://rubygems.org/</div><div class="line">gem <span class="built_in">source</span> <span class="_">-a</span> http://mirrors.aliyun.com/rubygems/</div></pre></td></tr></table></figure>

        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/blog/2014/05/16/use-fpm-to-create-python-rpm-packages/">使用 FPM 创建 Python 的 RPM 包</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2014-05-16
        </span>
        
          <div class="post-category">
            
              <a href="/blog/categories/it/">IT</a>
            
          </div>
        
        
      </div>
    </header>

    
    


    <div class="post-content">
      
        
        

        
          <p>生成 RPM 包太麻烦了，最近知道了一个名为 <a href="https://github.com/jordansissel/fpm" target="_blank" rel="external">FPM</a> 的神器，在此记录一下。</p>
<h2 id="安装-FPM"><a href="#安装-FPM" class="headerlink" title="安装 FPM"></a>安装 FPM</h2><p><strong>NOTE:</strong> 测试系统为 RedHat 系的 CentOS 6.3，编译 Python 2.7.6 的 RPM 包。</p>
<h3 id="安装-Ruby"><a href="#安装-Ruby" class="headerlink" title="安装 Ruby"></a>安装 Ruby</h3><p>由于 <a href="https://github.com/jordansissel/fpm" target="_blank" rel="external">FPM</a> 使用 <code>Ruby</code> 写成，因此系统中需要安装 <code>Ruby</code> 的运行环境（这里 <code>gem</code> 的源改为了 taobao 的镜像）：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># Install ruby dependencies</span></div><div class="line">yum -y install ruby rubygems ruby-devel</div><div class="line"><span class="comment"># Use taobao repo for ruby gems</span></div><div class="line">gem sources <span class="_">-a</span> http://ruby.taobao.org/</div><div class="line"><span class="comment"># Remove origin repo from ruby gems</span></div><div class="line">gem sources --remove http://rubygems.org/</div></pre></td></tr></table></figure>
<h3 id="通过-Gem-安装-FPM"><a href="#通过-Gem-安装-FPM" class="headerlink" title="通过 Gem 安装 FPM"></a>通过 Gem 安装 FPM</h3><p>在 <code>Ruby</code> 安装完成后，就可以使用 <code>gem</code> 安装 <a href="https://github.com/jordansissel/fpm" target="_blank" rel="external">FPM</a> 了：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># Install fpm</span></div><div class="line">gem install fpm</div></pre></td></tr></table></figure>
<p>Good.</p>
<h2 id="设置编译环境"><a href="#设置编译环境" class="headerlink" title="设置编译环境"></a>设置编译环境</h2><p>在编译 Python 之前，需要安装开发工具和库:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># Install EPEL repository</span></div><div class="line">wget http://dl.fedoraproject.org/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm</div><div class="line">wget http://rpms.famillecollet.com/enterprise/remi-release-6.rpm</div><div class="line">rpm -Uvh remi-release-6*.rpm epel-release-6*.rpm</div><div class="line"></div><div class="line"><span class="comment"># Install build toolchain</span></div><div class="line">yum -y groupinstall <span class="string">"Development tools"</span></div><div class="line">yum -y install openssl-devel readline-devel bzip2-devel sqlite-devel zlib-devel ncurses-devel db4-devel expat-devel</div></pre></td></tr></table></figure>
<h2 id="编译并创建-Python-的-RPM-包"><a href="#编译并创建-Python-的-RPM-包" class="headerlink" title="编译并创建 Python 的 RPM 包"></a>编译并创建 Python 的 RPM 包</h2><p><a href="https://github.com/jordansissel/fpm" target="_blank" rel="external">FPM</a> 的使用比较简单，可以参考 <a href="https://github.com/jordansissel/fpm" target="_blank" rel="external">FPM</a> 的 <a href="https://github.com/jordansissel/fpm/wiki" target="_blank" rel="external">使用说明</a>。</p>
<p>首先，下载 Python-2.7.6 的源码包并解压：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">curl --progress-bar -LO http://mirrors.sohu.com/python/2.7.6/Python-2.7.6.tgz</div><div class="line">tar xf Python-2.7.6.tgz</div></pre></td></tr></table></figure>
<p>第二步，编译 Python-2.7.6</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> Python-2.7.6.tgz</div><div class="line"></div><div class="line"><span class="comment"># Python2.7编译安装后会安装到这个目录，方便打包</span></div><div class="line"><span class="built_in">export</span> INTERMEDIATE_INSTALL_DIR=/tmp/installdir-Python-2.7.6</div><div class="line"><span class="comment"># RPM包安装后Python2.7的目录</span></div><div class="line"><span class="built_in">export</span> INSTALL_DIR=/usr/<span class="built_in">local</span></div><div class="line"></div><div class="line">LDFLAGS=<span class="string">"-Wl,-rpath=<span class="variable">$&#123;INSTALL_DIR&#125;</span>/lib <span class="variable">$&#123;LDFLAGS&#125;</span>"</span> \</div><div class="line">            ./configure --prefix=<span class="variable">$&#123;INSTALL_DIR&#125;</span> --enable-unicode=ucs4 \</div><div class="line">                --enable-shared --enable-ipv6</div><div class="line">make</div><div class="line">make install DESTDIR=<span class="variable">$&#123;INTERMEDIATE_INSTALL_DIR&#125;</span></div></pre></td></tr></table></figure>
<p>第三步，使用 <a href="https://github.com/jordansissel/fpm" target="_blank" rel="external">FPM</a> 创建 RPM 包：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 注意之前导出 INTERMEDIATE_INSTALL_DIR 和 INSTALL_DIR 这两个环境变量，这里还要使用</span></div><div class="line">fpm <span class="_">-s</span> dir -t <span class="_">-f</span> rpm -n python27 -v <span class="string">'2.7.6'</span> \</div><div class="line">    <span class="_">-d</span> <span class="string">'openssl'</span> \</div><div class="line">    <span class="_">-d</span> <span class="string">'bzip2'</span> \</div><div class="line">    <span class="_">-d</span> <span class="string">'zlib'</span> \</div><div class="line">    <span class="_">-d</span> <span class="string">'expat'</span> \</div><div class="line">    <span class="_">-d</span> <span class="string">'db4'</span> \</div><div class="line">    <span class="_">-d</span> <span class="string">'sqlite'</span> \</div><div class="line">    <span class="_">-d</span> <span class="string">'ncurses'</span> \</div><div class="line">    <span class="_">-d</span> <span class="string">'readline'</span> \</div><div class="line">    --directories=<span class="variable">$&#123;INSTALL_DIR&#125;</span>/lib/python2.7/ \</div><div class="line">    --directories=<span class="variable">$&#123;INSTALL_DIR&#125;</span>/include/python2.7/ \</div><div class="line">    -C <span class="variable">$&#123;INTERMEDIATE_INSTALL_DIR&#125;</span> .</div></pre></td></tr></table></figure>
<h2 id="Bonus-Time"><a href="#Bonus-Time" class="headerlink" title="Bonus Time"></a>Bonus Time</h2><p>包含以下内容：</p>
<ul>
<li>自动下载、编译、打包 Python RPM 包的 Makefile；</li>
<li>自动下载、编译、打包 virtualenv、pip、supervisor 等 Python 库和工具的 RPM 包。</li>
</ul>
<p>GitHub 项目地址：<a href="https://github.com/timonwong/python27-rpm" target="_blank" rel="external">python27-rpm</a></p>

        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/blog/2014/05/15/rabbitmq-note-3-pika-send-large-message/">RabbitMQ笔记（三）: Pika客户端（Python）发送大尺寸消息的问题</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2014-05-15
        </span>
        
          <div class="post-category">
            
              <a href="/blog/categories/it/">IT</a>
            
          </div>
        
        
      </div>
    </header>

    
    


    <div class="post-content">
      
        
        

        
          <h2 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h2><p>这个问题存在很久了，现象就是使用 <a href="https://pypi.python.org/pypi/pika/" target="_blank" rel="external">Pika</a> 库的客户端在发送大尺寸消息后，RabbitMQ
没有收到，Consumer 那里会认为消息已丢失。</p>
<p><strong>NOTE:</strong> 即使在本文写时的最新版(v0.9.13)依然存在这个问题。</p>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>因为网络状态很好，所以没有考虑网络的错误，直接考虑<a href="https://pypi.python.org/pypi/pika/" target="_blank" rel="external">Pika</a>库的问题。</p>
<p>那么第一步就是把 <a href="https://pypi.python.org/pypi/pika/" target="_blank" rel="external">Pika</a> 的代码拿来读一遍，主要看它是怎么发送消息的，经过一番探索，找到了
<code>pika/adapters/base_connection.py</code> 这个文件，来看看里面的内容：</p>
<figure class="highlight python"><figcaption><span>pika/adapters/base_connection.py</span><a href="https://github.com/pika/pika/blob/0.9.13/pika/adapters/base_connection.py#L329" target="_blank" rel="external">link</a></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">_handle_write</span><span class="params">(self)</span>:</span></div><div class="line">    <span class="string">"""Handle any outbound buffer writes that need to take place."""</span></div><div class="line">    total_written = <span class="number">0</span></div><div class="line">    <span class="keyword">if</span> self.outbound_buffer:</div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            bytes_written = self.socket.send(self.outbound_buffer.popleft())</div><div class="line">        <span class="keyword">except</span> socket.timeout:</div><div class="line">            <span class="keyword">raise</span></div><div class="line">        <span class="keyword">except</span> socket.error, error:</div><div class="line">            <span class="keyword">return</span> self._handle_error(error)</div><div class="line">        total_written += bytes_written</div><div class="line">    <span class="keyword">return</span> total_written</div></pre></td></tr></table></figure>
<p>看出问题了吗？</p>
<p>来看看<code>socket.send</code>的文档吧：</p>
<blockquote><p>Send data to the socket. The socket must be connected to a remote socket. The optional flags argument has the same meaning as for recv() above. Returns the number of bytes sent. Applications are responsible for checking that all data has been sent; if only some of the data was transmitted, the application needs to attempt delivery of the remaining data. For further information on this concept, consult the Socket Programming HOWTO.</p>
<footer><strong>Python Docs</strong><cite><a href="https://docs.python.org/2/library/socket.html#socket.socket.send" target="_blank" rel="external">socket.send</a></cite></footer></blockquote>
<p>问题就是，没有检查 <code>socket.send</code> 的返回值，由于 <code>socket.send</code> 返回实际发送的直接个数，可能会小于期望（在这里是
<code>self.outbound_buffer.popleft()</code>）。</p>
<p>由于 <code>socket.send</code> 可能没有将数据发送完成就返回了，造成了消息丢失的情况。</p>
<p>本来想自己修的，看了一眼 <a href="https://pypi.python.org/pypi/pika/" target="_blank" rel="external">Pika</a> 的 <code>master</code> 分支，已经修正了（一次保证将一个帧(Frame)发送完成）：</p>
<figure class="highlight python"><figcaption><span>pika/adapters/base_connection.py</span><a href="https://github.com/pika/pika/blob/master/pika/adapters/base_connection.py#L354" target="_blank" rel="external">link</a></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">_handle_write</span><span class="params">(self)</span>:</span></div><div class="line">    <span class="string">"""Handle any outbound buffer writes that need to take place."""</span></div><div class="line">    bytes_written = <span class="number">0</span></div><div class="line">    <span class="keyword">if</span> self.outbound_buffer:</div><div class="line">        frame = self.outbound_buffer.popleft()</div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            self.socket.sendall(frame)</div><div class="line">            bytes_written = len(frame)</div><div class="line">        <span class="keyword">except</span> socket.timeout:</div><div class="line">            <span class="keyword">raise</span></div><div class="line">        <span class="keyword">except</span> socket.error <span class="keyword">as</span> error:</div><div class="line">            <span class="keyword">return</span> self._handle_error(error)</div><div class="line">    <span class="keyword">return</span> bytes_written</div></pre></td></tr></table></figure>
<p>呵呵……</p>
<h2 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h2><ol>
<li>自行打补丁；</li>
<li>使用 <code>git</code> 上的 Pika: <code>pip install git+https://github.com/pika/pika.git</code>；</li>
<li>不用 <a href="https://pypi.python.org/pypi/pika/" target="_blank" rel="external">Pika</a>, 换其它的，比如 <a href="http://kombu.readthedocs.org/" target="_blank" rel="external">Kombu</a>。</li>
</ol>
<p>我现在不用 <a href="https://pypi.python.org/pypi/pika/" target="_blank" rel="external">Pika</a> 了，用 <a href="http://kombu.readthedocs.org/" target="_blank" rel="external">Kombu</a>。</p>
<p><strong>PS:</strong> <a href="https://pypi.python.org/pypi/pika/" target="_blank" rel="external">Pika</a> 的发布也太不积极了，都怎么久了还不发新版本。</p>

        
      
    </div>

    

    

  </article>

    
  </section>

  
  <nav class="pagination">
    
      <a class="prev" href="/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text">Prev</span>
      </a>
    
    
      <a class="next" href="/blog/page/3/">
        <span class="next-text">Next</span>
        <i class="iconfont icon-right"></i>
      </a>
    
  </nav>


          </div>
          

        </div>
      </main>

      <footer id="footer" class="footer">

  <div class="social-links">
    
      
        
          <a href="mailto:timon86.wang@gmail.com" class="iconfont icon-email" title="email"></a>
        
      
    
      
    
      
        
          <a href="https://twitter.com/timonwong" class="iconfont icon-twitter" title="twitter"></a>
        
      
    
      
    
      
    
      
    
      
        
          <a href="https://github.com/timonwong" class="iconfont icon-github" title="github"></a>
        
      
    
      
    
      
    
      
    
      
    
      
    
      
    
    
    
      <a href="/atom.xml" class="iconfont icon-rss" title="rss"></a>
    
  </div>



<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://hexo.io/">Hexo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/ahonn/hexo-theme-even">Even</a>
  </span>

  <span class="copyright-year">
    
    &copy; 
     
      2012 - 
    
    2017

    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">Timon Wong</span>
  </span>
</div>

      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>

    


    
  





  
    <script type="text/javascript" src="/lib/jquery/jquery-3.1.1.min.js"></script>
  

  
    <script type="text/javascript" src="/lib/slideout/slideout.js"></script>
  

  
    <script type="text/javascript" src="/lib/fancybox/jquery.fancybox.pack.js"></script>
  


<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      processEscapes: true,
      inlineMath: [ ['$','$'], ['\\(','\\)'] ],
      skipTags: [ 'script', 'noscript', 'style', 'textarea', 'pre', 'code' ]
    }
  });
</script>
<script type="text/javascript" async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script>

    <script type="text/javascript" src="/js/src/even.js?v=2.6.0"></script>
<script type="text/javascript" src="/js/src/bootstrap.js?v=2.6.0"></script><!-- hexo-inject:begin --><!-- hexo-inject:end -->

  </body>
</html>
